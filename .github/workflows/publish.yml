name: Publish to pub.dev
 
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Tag Git e vers√£o do package a ser publicada (ex: 1.2.3)"
        required: true
        type: string
 
      changelog:
        description: "CHANGELOG.md notes"
        required: true
        type: string
        default: "- Corre√ß√µes de bugs e melhorias de desempenho."
 
jobs:
  test_and_lint:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
 
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.2"
 
      - name: Run flutter pub get
        run: flutter pub get
 
      - name: Run flutter analyze (lint)
        run: flutter analyze
 
      - name: Run flutter tests
        run: flutter test
 
  validate:
    needs: test_and_lint
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
 
    steps:
      - uses: actions/checkout@v4
      - name: Validate version do pubspec.yaml e CHANGELOG.md
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "üîç Validando vers√£o $VERSION..."
 
          if grep -q "^version: $VERSION" pubspec.yaml; then
            echo "::error::A vers√£o $VERSION j√° est√° no pubspec.yaml."
            exit 1
          fi
 
          if grep -q "^## $VERSION" CHANGELOG.md; then
            echo "::error::A vers√£o $VERSION j√° existe no CHANGELOG.md."
            exit 1
          fi
 
          echo "‚úÖ Vers√£o n√£o encontrada, continuar."
 
  update_version:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
 
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - name: Atualizar vers√£o no pubspec.yaml
        run: |
          sed -i "s/^version:.*/version: ${{ github.event.inputs.version }}/" pubspec.yaml
 
      - name: Atualizar CHANGELOG.md
        run: printf '%s\n\n%s\n\n%s\n' "## ${{ github.event.inputs.version }}" "${{ github.event.inputs.changelog }}" "$(cat CHANGELOG.md)" > CHANGELOG.md
 
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
 
          git add pubspec.yaml CHANGELOG.md
          git commit -m "chore: release ${{ github.event.inputs.version }}" || echo "Nenhuma mudan√ßa"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
  publish:
    needs: update_version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
 
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest commit from main
        run: |
          git fetch origin main
          git checkout main
          git pull origin main
 
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.2"
 
      - run: flutter pub get
 
      # s√≥ dry-run aqui, pois lint e test j√° foram feitos no job 1
      - run: dart pub publish --dry-run
 
      - name: Save pub.dev credentials
        run: |
          mkdir -p ~/.config/dart

          # ‚úÖ Valida√ß√£o se diret√≥rio foi criado
          if [ ! -d ~/.config/dart ]; then
            echo "::error::Falha ao criar diret√≥rio ~/.config/dart"
            exit 1
          fi
 
          echo ${{ secrets.PUB_CREDENTIALS }} | base64 --decode > ~/.config/dart/pub-credentials.json
 
          # ‚úÖ Valida√ß√£o se o arquivo foi criado
          if [ ! -f ~/.config/dart/pub-credentials.json ]; then
            echo "::error::Arquivo pub-credentials.json n√£o foi criado!"
            exit 1
          fi
          echo "‚úÖ Credenciais salvas com sucesso."
          ls -la ~/.config/dart
 
      - name: Publish package
        id: publish
        run: dart pub publish --force
 
      - name: Cleanup credentials
        if: always()
        run: rm -rf ~/.config/dart
 
      - name: Criar e push da TAG ap√≥s sucesso
        if: success()
        run: |
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}